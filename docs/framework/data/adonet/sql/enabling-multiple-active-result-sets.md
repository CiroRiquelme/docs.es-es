---
title: Habilitación de conjuntos de resultados activos múltiples
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 576079e4-debe-4ab5-9204-fcbe2ca7a5e2
ms.openlocfilehash: 72125be835298218e5445fe1915d6a17f5008bb2
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/12/2020
ms.locfileid: "79148730"
---
# <a name="enabling-multiple-active-result-sets"></a><span data-ttu-id="7cb80-102">Habilitación de conjuntos de resultados activos múltiples</span><span class="sxs-lookup"><span data-stu-id="7cb80-102">Enabling Multiple Active Result Sets</span></span>
<span data-ttu-id="7cb80-103">Los conjuntos de resultados activos múltiples (MARS) son una característica que funciona con SQL Server y que permite la ejecución de varios lotes en una sola conexión.</span><span class="sxs-lookup"><span data-stu-id="7cb80-103">Multiple Active Result Sets (MARS) is a feature that works with SQL Server to allow the execution of multiple batches on a single connection.</span></span> <span data-ttu-id="7cb80-104">Cuando MARS está habilitado para su uso con SQL Server, cada objeto de comando usado agrega una sesión a la conexión.</span><span class="sxs-lookup"><span data-stu-id="7cb80-104">When MARS is enabled for use with SQL Server, each command object used adds a session to the connection.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="7cb80-105">Una sola sesión de MARS abre una conexión lógica para que MARS la use y, a continuación, una conexión lógica para cada comando activo.</span><span class="sxs-lookup"><span data-stu-id="7cb80-105">A single MARS session opens one logical connection for MARS to use and then one logical connection for each active command.</span></span>  
  
## <a name="enabling-and-disabling-mars-in-the-connection-string"></a><span data-ttu-id="7cb80-106">Habilitación y deshabilitación de MARS en la cadena de conexión</span><span class="sxs-lookup"><span data-stu-id="7cb80-106">Enabling and Disabling MARS in the Connection String</span></span>  
  
> [!NOTE]
> <span data-ttu-id="7cb80-107">En las siguientes cadenas de conexión se usa la base de datos de ejemplo **AdventureWorks** que se incluye en SQL Server.</span><span class="sxs-lookup"><span data-stu-id="7cb80-107">The following connection strings use the sample **AdventureWorks** database included with SQL Server.</span></span> <span data-ttu-id="7cb80-108">Las cadenas de conexión proporcionadas suponen que la base de datos está instalada en un servidor llamado MSSQL1.</span><span class="sxs-lookup"><span data-stu-id="7cb80-108">The connection strings provided assume that the database is installed on a server named MSSQL1.</span></span> <span data-ttu-id="7cb80-109">Modifique la cadena de conexión según sea necesario para el entorno.</span><span class="sxs-lookup"><span data-stu-id="7cb80-109">Modify the connection string as necessary for your environment.</span></span>  
  
 <span data-ttu-id="7cb80-110">La característica MARS está deshabilitada de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="7cb80-110">The MARS feature is disabled by default.</span></span> <span data-ttu-id="7cb80-111">Se puede habilitar agregando el par de palabras clave "MultipleActiveResultSets=True" a la cadena de conexión.</span><span class="sxs-lookup"><span data-stu-id="7cb80-111">It can be enabled by adding the "MultipleActiveResultSets=True" keyword pair to your connection string.</span></span> <span data-ttu-id="7cb80-112">"True" es el único valor válido para habilitar MARS.</span><span class="sxs-lookup"><span data-stu-id="7cb80-112">"True" is the only valid value for enabling MARS.</span></span> <span data-ttu-id="7cb80-113">En el ejemplo siguiente se muestra cómo conectarse a una instancia de SQL Server y cómo especificar que se debe habilitar MARS.</span><span class="sxs-lookup"><span data-stu-id="7cb80-113">The following example demonstrates how to connect to an instance of SQL Server and how to specify that MARS should be enabled.</span></span>  
  
```vb  
Dim connectionString As String = "Data Source=MSSQL1;" & _  
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" & _  
    "MultipleActiveResultSets=True"  
```  
  
```csharp  
string connectionString = "Data Source=MSSQL1;" +
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" +  
    "MultipleActiveResultSets=True";  
```  
  
 <span data-ttu-id="7cb80-114">Puede deshabilitar MARS agregando el par de palabras clave "MultipleActiveResultSets=False" a la cadena de conexión.</span><span class="sxs-lookup"><span data-stu-id="7cb80-114">You can disable MARS by adding the "MultipleActiveResultSets=False" keyword pair to your connection string.</span></span> <span data-ttu-id="7cb80-115">"False" es el único valor válido para deshabilitar MARS.</span><span class="sxs-lookup"><span data-stu-id="7cb80-115">"False" is the only valid value for disabling MARS.</span></span> <span data-ttu-id="7cb80-116">La siguiente cadena de conexión muestra cómo deshabilitar MARS.</span><span class="sxs-lookup"><span data-stu-id="7cb80-116">The following connection string demonstrates how to disable MARS.</span></span>  
  
```vb  
Dim connectionString As String = "Data Source=MSSQL1;" & _  
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" & _  
    "MultipleActiveResultSets=False"  
```  
  
```csharp  
string connectionString = "Data Source=MSSQL1;" +
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" +  
    "MultipleActiveResultSets=False";  
```  
  
## <a name="special-considerations-when-using-mars"></a><span data-ttu-id="7cb80-117">Consideraciones especiales al utilizar MARS</span><span class="sxs-lookup"><span data-stu-id="7cb80-117">Special Considerations When Using MARS</span></span>  
 <span data-ttu-id="7cb80-118">En general, no es necesario modificar las aplicaciones existentes para utilizar una conexión habilitada para MARS.</span><span class="sxs-lookup"><span data-stu-id="7cb80-118">In general, existing applications should not need modification to use a MARS-enabled connection.</span></span> <span data-ttu-id="7cb80-119">Sin embargo, si desea usar las características de MARS en sus aplicaciones, debe comprender las siguientes consideraciones especiales.</span><span class="sxs-lookup"><span data-stu-id="7cb80-119">However, if you wish to use MARS features in your applications, you should understand the following special considerations.</span></span>  
  
### <a name="statement-interleaving"></a><span data-ttu-id="7cb80-120">Entrelazado de instrucciones</span><span class="sxs-lookup"><span data-stu-id="7cb80-120">Statement Interleaving</span></span>  
 <span data-ttu-id="7cb80-121">Las operaciones de MARS se ejecutan sincrónicamente en el servidor.</span><span class="sxs-lookup"><span data-stu-id="7cb80-121">MARS operations execute synchronously on the server.</span></span> <span data-ttu-id="7cb80-122">Se permite la intercalación de instrucciones SELECT y BULK INSERT.</span><span class="sxs-lookup"><span data-stu-id="7cb80-122">Statement interleaving of SELECT and BULK INSERT statements is allowed.</span></span> <span data-ttu-id="7cb80-123">Sin embargo, las instrucciones del lenguaje de manipulación de datos (DML) y del lenguaje de definición de datos (DDL) se ejecutan de forma atómica.</span><span class="sxs-lookup"><span data-stu-id="7cb80-123">However, data manipulation language (DML) and data definition language (DDL) statements execute atomically.</span></span> <span data-ttu-id="7cb80-124">Las instrucciones que intentan ejecutarse mientras se ejecuta un lote atómico están bloqueadas.</span><span class="sxs-lookup"><span data-stu-id="7cb80-124">Any statements attempting to execute while an atomic batch is executing are blocked.</span></span> <span data-ttu-id="7cb80-125">La ejecución en paralelo en el servidor no es una característica de MARS.</span><span class="sxs-lookup"><span data-stu-id="7cb80-125">Parallel execution at the server is not a MARS feature.</span></span>  
  
 <span data-ttu-id="7cb80-126">Si se envían dos lotes en una conexión de MARS, uno de ellos con una instrucción SELECT y otro con una instrucción DML, el DML puede empezar a ejecutarse dentro de la ejecución de la instrucción SELECT.</span><span class="sxs-lookup"><span data-stu-id="7cb80-126">If two batches are submitted under a MARS connection, one of them containing a SELECT statement, the other containing a DML statement, the DML can begin execution within execution of the SELECT statement.</span></span> <span data-ttu-id="7cb80-127">Sin embargo, la instrucción DML debe ejecutarse hasta completarse antes de que la instrucción SELECT pueda progresar.</span><span class="sxs-lookup"><span data-stu-id="7cb80-127">However, the DML statement must run to completion before the SELECT statement can make progress.</span></span> <span data-ttu-id="7cb80-128">Si ambas instrucciones se ejecutan en la misma transacción, los cambios realizados por una instrucción DML después de que haya comenzado la ejecución de la instrucción SELECT no son visibles para la operación de lectura.</span><span class="sxs-lookup"><span data-stu-id="7cb80-128">If both statements are running under the same transaction, any changes made by a DML statement after the SELECT statement has started execution are not visible to the read operation.</span></span>  
  
 <span data-ttu-id="7cb80-129">Una instrucción WAITFOR dentro de una instrucción SELECT no produce la transacción mientras está en espera, es decir, hasta que se produce la primera fila.</span><span class="sxs-lookup"><span data-stu-id="7cb80-129">A WAITFOR statement inside a SELECT statement does not yield the transaction while it is waiting, that is, until the first row is produced.</span></span> <span data-ttu-id="7cb80-130">Esto implica que no se pueden ejecutar otros lotes dentro de la misma conexión mientras una instrucción WAITFOR está en espera.</span><span class="sxs-lookup"><span data-stu-id="7cb80-130">This implies that no other batches can execute within the same connection while a WAITFOR statement is waiting.</span></span>  
  
### <a name="mars-session-cache"></a><span data-ttu-id="7cb80-131">Caché de sesiones MARS</span><span class="sxs-lookup"><span data-stu-id="7cb80-131">MARS Session Cache</span></span>  
 <span data-ttu-id="7cb80-132">Cuando se abre una conexión con MARS habilitado, se crea una sesión lógica que agrega sobrecarga adicional.</span><span class="sxs-lookup"><span data-stu-id="7cb80-132">When a connection is opened with MARS enabled, a logical session is created, which adds additional overhead.</span></span> <span data-ttu-id="7cb80-133">Para minimizar la sobrecarga y mejorar el rendimiento, **SqlClient** almacena en caché la sesión MARS de una conexión.</span><span class="sxs-lookup"><span data-stu-id="7cb80-133">To minimize overhead and enhance performance, **SqlClient** caches the MARS session within a connection.</span></span> <span data-ttu-id="7cb80-134">La memoria caché contiene como máximo 10 sesiones de MARS.</span><span class="sxs-lookup"><span data-stu-id="7cb80-134">The cache contains at most 10 MARS sessions.</span></span> <span data-ttu-id="7cb80-135">Este valor no se puede especificar por el usuario.</span><span class="sxs-lookup"><span data-stu-id="7cb80-135">This value is not user adjustable.</span></span> <span data-ttu-id="7cb80-136">Si se alcanza el límite de la sesión, se crea una nueva sesión: no se genera un error.</span><span class="sxs-lookup"><span data-stu-id="7cb80-136">If the session limit is reached, a new session is created—an error is not generated.</span></span> <span data-ttu-id="7cb80-137">La memoria caché y las sesiones que contiene son para cada una de las conexiones; no se comparten entre ellas.</span><span class="sxs-lookup"><span data-stu-id="7cb80-137">The cache and sessions contained in it are per-connection; they are not shared across connections.</span></span> <span data-ttu-id="7cb80-138">Cuando se libera una sesión, se devuelve al grupo a menos que se haya alcanzado el límite superior del grupo.</span><span class="sxs-lookup"><span data-stu-id="7cb80-138">When a session is released, it is returned to the pool unless the pool's upper limit has been reached.</span></span> <span data-ttu-id="7cb80-139">Si el grupo de la caché está lleno, se cierra la sesión.</span><span class="sxs-lookup"><span data-stu-id="7cb80-139">If the cache pool is full, the session is closed.</span></span> <span data-ttu-id="7cb80-140">Las sesiones de MARS no expiran.</span><span class="sxs-lookup"><span data-stu-id="7cb80-140">MARS sessions do not expire.</span></span> <span data-ttu-id="7cb80-141">Solo se limpian cuando se desecha el objeto de conexión.</span><span class="sxs-lookup"><span data-stu-id="7cb80-141">They are only cleaned up when the connection object is disposed.</span></span> <span data-ttu-id="7cb80-142">La caché de la sesión de MARS no se ha cargado previamente.</span><span class="sxs-lookup"><span data-stu-id="7cb80-142">The MARS session cache is not preloaded.</span></span> <span data-ttu-id="7cb80-143">Se carga a medida que la aplicación requiere más sesiones.</span><span class="sxs-lookup"><span data-stu-id="7cb80-143">It is loaded as the application requires more sessions.</span></span>  
  
### <a name="thread-safety"></a><span data-ttu-id="7cb80-144">Seguridad para subprocesos</span><span class="sxs-lookup"><span data-stu-id="7cb80-144">Thread Safety</span></span>  
 <span data-ttu-id="7cb80-145">Las operaciones MARS no son seguras para subprocesos.</span><span class="sxs-lookup"><span data-stu-id="7cb80-145">MARS operations are not thread-safe.</span></span>  
  
### <a name="connection-pooling"></a><span data-ttu-id="7cb80-146">Agrupar conexiones</span><span class="sxs-lookup"><span data-stu-id="7cb80-146">Connection Pooling</span></span>  
 <span data-ttu-id="7cb80-147">Las conexiones habilitadas para MARS se agrupan como cualquier otra conexión.</span><span class="sxs-lookup"><span data-stu-id="7cb80-147">MARS-enabled connections are pooled like any other connection.</span></span> <span data-ttu-id="7cb80-148">Si una aplicación abre dos conexiones, una con MARS habilitado y otra con MARS deshabilitado, las dos conexiones se ubican en grupos independientes.</span><span class="sxs-lookup"><span data-stu-id="7cb80-148">If an application opens two connections, one with MARS enabled and one with MARS disabled, the two connections are in separate pools.</span></span> <span data-ttu-id="7cb80-149">Para más información, consulte el artículo sobre la [agrupación de conexiones de SQL Server (ADO.NET)](../sql-server-connection-pooling.md).</span><span class="sxs-lookup"><span data-stu-id="7cb80-149">For more information, see [SQL Server Connection Pooling (ADO.NET)](../sql-server-connection-pooling.md).</span></span>  
  
### <a name="sql-server-batch-execution-environment"></a><span data-ttu-id="7cb80-150">Entorno de ejecución por lotes de SQL Server</span><span class="sxs-lookup"><span data-stu-id="7cb80-150">SQL Server Batch Execution Environment</span></span>  
 <span data-ttu-id="7cb80-151">Cuando se abre una conexión, se define un entorno predeterminado.</span><span class="sxs-lookup"><span data-stu-id="7cb80-151">When a connection is opened, a default environment is defined.</span></span> <span data-ttu-id="7cb80-152">A continuación, este entorno se copia en una sesión de MARS lógica.</span><span class="sxs-lookup"><span data-stu-id="7cb80-152">This environment is then copied into a logical MARS session.</span></span>  
  
 <span data-ttu-id="7cb80-153">El entorno de ejecución de lotes incluye los siguientes componentes:</span><span class="sxs-lookup"><span data-stu-id="7cb80-153">The batch execution environment includes the following components:</span></span>  
  
- <span data-ttu-id="7cb80-154">Opciones de Set (por ejemplo, ANSI_NULLS, DATE_FORMAT, LANGUAGE, TEXTSIZE)</span><span class="sxs-lookup"><span data-stu-id="7cb80-154">Set options (for example, ANSI_NULLS, DATE_FORMAT, LANGUAGE, TEXTSIZE)</span></span>  
  
- <span data-ttu-id="7cb80-155">Contexto de seguridad (rol de usuario/aplicación)</span><span class="sxs-lookup"><span data-stu-id="7cb80-155">Security context (user/application role)</span></span>  
  
- <span data-ttu-id="7cb80-156">Contexto de base de datos (base de datos actual)</span><span class="sxs-lookup"><span data-stu-id="7cb80-156">Database context (current database)</span></span>  
  
- <span data-ttu-id="7cb80-157">Variables de estado de ejecución (por ejemplo, @@ERROR, @@ROWCOUNT, @@FETCH_STATUS @@IDENTITY)</span><span class="sxs-lookup"><span data-stu-id="7cb80-157">Execution state variables (for example, @@ERROR, @@ROWCOUNT, @@FETCH_STATUS @@IDENTITY)</span></span>  
  
- <span data-ttu-id="7cb80-158">Tablas temporales de nivel superior</span><span class="sxs-lookup"><span data-stu-id="7cb80-158">Top-level temporary tables</span></span>  
  
 <span data-ttu-id="7cb80-159">Con MARS, un entorno de ejecución predeterminado está asociado a una conexión.</span><span class="sxs-lookup"><span data-stu-id="7cb80-159">With MARS, a default execution environment is associated to a connection.</span></span> <span data-ttu-id="7cb80-160">Cada nuevo lote que empieza a ejecutarse en una conexión determinada recibe una copia del entorno predeterminado.</span><span class="sxs-lookup"><span data-stu-id="7cb80-160">Every new batch that starts executing under a given connection receives a copy of the default environment.</span></span> <span data-ttu-id="7cb80-161">Siempre que el código se ejecuta en un lote determinado, todos los cambios realizados en el entorno se limitan al lote específico.</span><span class="sxs-lookup"><span data-stu-id="7cb80-161">Whenever code is executed under a given batch, all changes made to the environment are scoped to the specific batch.</span></span> <span data-ttu-id="7cb80-162">Cuando finaliza la ejecución, su configuración se copia en el entorno predeterminado.</span><span class="sxs-lookup"><span data-stu-id="7cb80-162">Once execution finishes, the execution settings are copied into the default environment.</span></span> <span data-ttu-id="7cb80-163">En el caso de un solo lote que emite varios comandos de ejecución secuencial en la misma transacción, las semánticas son las mismas que aquellas que exponen conexiones en las que intervienen clientes o servidores de versiones anteriores.</span><span class="sxs-lookup"><span data-stu-id="7cb80-163">In the case of a single batch issuing several commands to be executed sequentially under the same transaction, semantics are the same as those exposed by connections involving earlier clients or servers.</span></span>  
  
### <a name="parallel-execution"></a><span data-ttu-id="7cb80-164">Ejecución paralela</span><span class="sxs-lookup"><span data-stu-id="7cb80-164">Parallel Execution</span></span>  
 <span data-ttu-id="7cb80-165">MARS no está diseñado para quitar todos los requisitos de varias conexiones en una aplicación.</span><span class="sxs-lookup"><span data-stu-id="7cb80-165">MARS is not designed to remove all requirements for multiple connections in an application.</span></span> <span data-ttu-id="7cb80-166">Si una aplicación necesita la verdadera ejecución en paralelo de comandos en un servidor, se deben usar varias conexiones.</span><span class="sxs-lookup"><span data-stu-id="7cb80-166">If an application needs true parallel execution of commands against a server, multiple connections should be used.</span></span>  
  
 <span data-ttu-id="7cb80-167">Por ejemplo, tenga en cuenta el siguiente caso.</span><span class="sxs-lookup"><span data-stu-id="7cb80-167">For example, consider the following scenario.</span></span> <span data-ttu-id="7cb80-168">Se crean dos objetos de comando, uno para procesar un conjunto de resultados y otro para actualizar los datos; comparten una conexión común a través de MARS.</span><span class="sxs-lookup"><span data-stu-id="7cb80-168">Two command objects are created, one for processing a result set and another for updating data; they share a common connection via MARS.</span></span> <span data-ttu-id="7cb80-169">En este escenario, la transacción `Transaction`.`Commit`</span><span class="sxs-lookup"><span data-stu-id="7cb80-169">In this scenario, the `Transaction`.`Commit`</span></span> <span data-ttu-id="7cb80-170">no puede realizar la actualización hasta que todos los resultados se han leído en el primer objeto de comando, lo que produce la siguiente excepción:</span><span class="sxs-lookup"><span data-stu-id="7cb80-170">fails on the update until all the results have been read on the first command object, yielding the following exception:</span></span>  
  
 <span data-ttu-id="7cb80-171">Mensaje: Contexto de transacción en uso por otra sesión.</span><span class="sxs-lookup"><span data-stu-id="7cb80-171">Message: Transaction context in use by another session.</span></span>  
  
 <span data-ttu-id="7cb80-172">Origen: Proveedor de datos SqlClient de .NET</span><span class="sxs-lookup"><span data-stu-id="7cb80-172">Source: .NET SqlClient Data Provider</span></span>  
  
 <span data-ttu-id="7cb80-173">Se esperaba: (NULL)</span><span class="sxs-lookup"><span data-stu-id="7cb80-173">Expected: (null)</span></span>  
  
 <span data-ttu-id="7cb80-174">Recibido: System.Data.SqlClient.SqlException</span><span class="sxs-lookup"><span data-stu-id="7cb80-174">Received: System.Data.SqlClient.SqlException</span></span>  
  
 <span data-ttu-id="7cb80-175">Hay tres opciones para ocuparse de este escenario:</span><span class="sxs-lookup"><span data-stu-id="7cb80-175">There are three options for handling this scenario:</span></span>  
  
1. <span data-ttu-id="7cb80-176">Inicie la transacción una vez creado el lector, de modo que no forme parte de la transacción.</span><span class="sxs-lookup"><span data-stu-id="7cb80-176">Start the transaction after the reader is created, so that it is not part of the transaction.</span></span> <span data-ttu-id="7cb80-177">Cada actualización se convierte entonces en su propia transacción.</span><span class="sxs-lookup"><span data-stu-id="7cb80-177">Every update then becomes its own transaction.</span></span>  
  
2. <span data-ttu-id="7cb80-178">Confirme todo el trabajo después de cerrar el lector.</span><span class="sxs-lookup"><span data-stu-id="7cb80-178">Commit all work after the reader is closed.</span></span> <span data-ttu-id="7cb80-179">Con ello cabe la posibilidad de juntarse con un lote sustancial de actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="7cb80-179">This has the potential for a substantial batch of updates.</span></span>  
  
3. <span data-ttu-id="7cb80-180">No use MARS; en su lugar, use una conexión independiente para cada objeto de comando como lo haría antes de MARS.</span><span class="sxs-lookup"><span data-stu-id="7cb80-180">Don't use MARS; instead use a separate connection for each command object as you would have before MARS.</span></span>  
  
### <a name="detecting-mars-support"></a><span data-ttu-id="7cb80-181">Detección de compatibilidad con MARS</span><span class="sxs-lookup"><span data-stu-id="7cb80-181">Detecting MARS Support</span></span>  
 <span data-ttu-id="7cb80-182">Una aplicación puede comprobar la compatibilidad con MARS leyendo el valor de `SqlConnection.ServerVersion`.</span><span class="sxs-lookup"><span data-stu-id="7cb80-182">An application can check for MARS support by reading the `SqlConnection.ServerVersion` value.</span></span> <span data-ttu-id="7cb80-183">El número mayor debe ser 9 en SQL Server 2005 y 10 en SQL Server 2008.</span><span class="sxs-lookup"><span data-stu-id="7cb80-183">The major number should be 9 for SQL Server 2005 and 10 for SQL Server 2008.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7cb80-184">Consulte también</span><span class="sxs-lookup"><span data-stu-id="7cb80-184">See also</span></span>

- [<span data-ttu-id="7cb80-185">Conjuntos de resultados activos múltiples (MARS)</span><span class="sxs-lookup"><span data-stu-id="7cb80-185">Multiple Active Result Sets (MARS)</span></span>](multiple-active-result-sets-mars.md)
- [<span data-ttu-id="7cb80-186">Información general de ADO.NET</span><span class="sxs-lookup"><span data-stu-id="7cb80-186">ADO.NET Overview</span></span>](../ado-net-overview.md)
