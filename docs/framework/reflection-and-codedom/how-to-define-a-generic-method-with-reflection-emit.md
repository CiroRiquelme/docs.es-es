---
title: Procedimiento para definir un tipo genérico con emisión de reflexión
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- generics [.NET Framework], reflection emit
- reflection emit, generic methods
- generics [.NET Framework], dynamic types
ms.assetid: 93892fa4-90b3-4ec4-b147-4bec9880de2b
ms.openlocfilehash: d16f6728b01583fe3ffb8d892522f3892444c537
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 10/30/2019
ms.locfileid: "73130170"
---
# <a name="how-to-define-a-generic-method-with-reflection-emit"></a><span data-ttu-id="29996-102">Procedimiento para definir un tipo genérico con emisión de reflexión</span><span class="sxs-lookup"><span data-stu-id="29996-102">How to: Define a Generic Method with Reflection Emit</span></span>

<span data-ttu-id="29996-103">El primer procedimiento explica cómo crear un método genérico simple con dos parámetros de tipo y cómo aplicar restricciones de clase, restricciones de interfaz y restricciones especiales a los parámetros de tipo.</span><span class="sxs-lookup"><span data-stu-id="29996-103">The first procedure shows how to create a simple generic method with two type parameters, and how to apply class constraints, interface constraints, and special constraints to the type parameters.</span></span>

<span data-ttu-id="29996-104">El segundo procedimiento muestra cómo emitir el cuerpo del método y cómo utilizar los parámetros de tipo del método genérico para crear instancias de tipos genéricos y llamar a sus métodos.</span><span class="sxs-lookup"><span data-stu-id="29996-104">The second procedure shows how to emit the method body, and how to use the type parameters of the generic method to create instances of generic types and to call their methods.</span></span>

<span data-ttu-id="29996-105">El tercero de los procedimientos explica cómo invocar el método genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-105">The third procedure shows how to invoke the generic method.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="29996-106">Un método no es genérico sólo porque pertenece a un tipo genérico y utiliza los parámetros de tipo de ese tipo genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-106">A method is not generic just because it belongs to a generic type and uses the type parameters of that type.</span></span> <span data-ttu-id="29996-107">Un método sólo es genérico si tiene su propia lista de parámetros de tipo.</span><span class="sxs-lookup"><span data-stu-id="29996-107">A method is generic only if it has its own type parameter list.</span></span> <span data-ttu-id="29996-108">Un método genérico puede aparecer en un tipo no genérico, como se puede ver en este ejemplo.</span><span class="sxs-lookup"><span data-stu-id="29996-108">A generic method can appear on a nongeneric type, as in this example.</span></span> <span data-ttu-id="29996-109">Para obtener un ejemplo de un método no genérico en un tipo genérico, vea [Cómo: Definir un tipo genérico con emisión de reflexión](how-to-define-a-generic-type-with-reflection-emit.md).</span><span class="sxs-lookup"><span data-stu-id="29996-109">For an example of a nongeneric method on a generic type, see [How to: Define a Generic Type with Reflection Emit](how-to-define-a-generic-type-with-reflection-emit.md).</span></span>

### <a name="to-define-a-generic-method"></a><span data-ttu-id="29996-110">Para definir un método genérico</span><span class="sxs-lookup"><span data-stu-id="29996-110">To define a generic method</span></span>

1. <span data-ttu-id="29996-111">Antes de comenzar, resulta de utilidad examinar cómo aparece el método genérico cuando se escribe utilizando un lenguaje de alto nivel.</span><span class="sxs-lookup"><span data-stu-id="29996-111">Before beginning, it is useful to look at how the generic method appears when written using a high-level language.</span></span> <span data-ttu-id="29996-112">El código siguiente se incluye en el código de ejemplo de este tema, junto con el código para llamar al método genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-112">The following code is included in the example code for this topic, along with code to call the generic method.</span></span> <span data-ttu-id="29996-113">El método tiene dos parámetros de tipo, `TInput` y `TOutput`, el segundo de los cuales debe ser de un tipo de referencia (`class`), tener un constructor sin parámetros (`new`) e implementar `ICollection(Of TInput)` (`ICollection<TInput>` en C#).</span><span class="sxs-lookup"><span data-stu-id="29996-113">The method has two type parameters, `TInput` and `TOutput`, the second of which must be a reference type (`class`), must have a parameterless constructor (`new`), and must implement `ICollection(Of TInput)` (`ICollection<TInput>` in C#).</span></span> <span data-ttu-id="29996-114">Esta restricción de interfaz garantiza que el método <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> se puede utilizar para agregar los elementos a la colección `TOutput` que crea el método.</span><span class="sxs-lookup"><span data-stu-id="29996-114">This interface constraint ensures that the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method can be used to add elements to the `TOutput` collection that the method creates.</span></span> <span data-ttu-id="29996-115">El método tiene un parámetro formal, `input`, que es una matriz de `TInput`.</span><span class="sxs-lookup"><span data-stu-id="29996-115">The method has one formal parameter, `input`, which is an array of `TInput`.</span></span> <span data-ttu-id="29996-116">El método crea una colección de tipo `TOutput` y copia los elementos de `input` en la colección.</span><span class="sxs-lookup"><span data-stu-id="29996-116">The method creates a collection of type `TOutput` and copies the elements of `input` to the collection.</span></span>

    [!code-csharp[GenericMethodHowTo#20](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#20)]
    [!code-vb[GenericMethodHowTo#20](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#20)]

2. <span data-ttu-id="29996-117">Defina un ensamblado dinámico y un módulo dinámico para contener el tipo al que pertenece el método genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-117">Define a dynamic assembly and a dynamic module to contain the type the generic method belongs to.</span></span> <span data-ttu-id="29996-118">En este caso, el ensamblado sólo tiene un módulo, denominado `DemoMethodBuilder1`, y el nombre del módulo es el mismo que el nombre del ensamblado más una extensión.</span><span class="sxs-lookup"><span data-stu-id="29996-118">In this case, the assembly has only one module, named `DemoMethodBuilder1`, and the module name is the same as the assembly name plus an extension.</span></span> <span data-ttu-id="29996-119">En este ejemplo, el ensamblado se guarda en el disco y se ejecuta, por lo que se especifica <xref:System.Reflection.Emit.AssemblyBuilderAccess.RunAndSave?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="29996-119">In this example, the assembly is saved to disk and also executed, so <xref:System.Reflection.Emit.AssemblyBuilderAccess.RunAndSave?displayProperty=nameWithType> is specified.</span></span> <span data-ttu-id="29996-120">Puede usar [Ildasm.exe (Desensamblador de IL)](../tools/ildasm-exe-il-disassembler.md) para examinar DemoMethodBuilder1.dll y compararlo con el lenguaje intermedio de Microsoft (MSIL) para el método que se muestra en el paso 1.</span><span class="sxs-lookup"><span data-stu-id="29996-120">You can use the [Ildasm.exe (IL Disassembler)](../tools/ildasm-exe-il-disassembler.md) to examine DemoMethodBuilder1.dll and to compare it to the Microsoft intermediate language (MSIL) for the method shown in step 1.</span></span>

    [!code-csharp[GenericMethodHowTo#2](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#2)]
    [!code-vb[GenericMethodHowTo#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#2)]

3. <span data-ttu-id="29996-121">Defina el tipo al que pertenece la definición de método genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-121">Define the type the generic method belongs to.</span></span> <span data-ttu-id="29996-122">No es necesario que el tipo sea genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-122">The type does not have to be generic.</span></span> <span data-ttu-id="29996-123">Una definición de método genérico puede pertenecer tanto a un tipo genérico como no genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-123">A generic method can belong to either a generic or nongeneric type.</span></span> <span data-ttu-id="29996-124">En este ejemplo, el tipo es una clase, no es genérico y se denomina `DemoType`.</span><span class="sxs-lookup"><span data-stu-id="29996-124">In this example, the type is a class, is not generic, and is named `DemoType`.</span></span>

    [!code-csharp[GenericMethodHowTo#3](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#3)]
    [!code-vb[GenericMethodHowTo#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#3)]

4. <span data-ttu-id="29996-125">Defina el método genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-125">Define the generic method.</span></span> <span data-ttu-id="29996-126">Si los tipos de los parámetros formales de un método genérico se especifican mediante los parámetros de tipo genérico del método genérico, utilice la sobrecarga del método <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%28System.String%2CSystem.Reflection.MethodAttributes%29> para definir el método.</span><span class="sxs-lookup"><span data-stu-id="29996-126">If the types of a generic method's formal parameters are specified by generic type parameters of the generic method, use the <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%28System.String%2CSystem.Reflection.MethodAttributes%29> method overload to define the method.</span></span> <span data-ttu-id="29996-127">Los parámetros de tipo genérico del método todavía no están definidos, por lo que no puede especificar los tipos de los parámetros formales del método en la llamada a <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%2A>.</span><span class="sxs-lookup"><span data-stu-id="29996-127">The generic type parameters of the method are not yet defined, so you cannot specify the types of the method's formal parameters in the call to <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%2A>.</span></span> <span data-ttu-id="29996-128">En este ejemplo, el método se denomina `Factory`.</span><span class="sxs-lookup"><span data-stu-id="29996-128">In this example, the method is named `Factory`.</span></span> <span data-ttu-id="29996-129">El método es público y `static` (`Shared` en Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="29996-129">The method is public and `static` (`Shared` in Visual Basic).</span></span>

    [!code-csharp[GenericMethodHowTo#4](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#4)]
    [!code-vb[GenericMethodHowTo#4](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#4)]

5. <span data-ttu-id="29996-130">Defina los parámetros de tipo genérico de `DemoMethod` pasando una matriz de cadenas que contienen los nombres de los parámetros al método <xref:System.Reflection.Emit.MethodBuilder.DefineGenericParameters%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="29996-130">Define the generic type parameters of `DemoMethod` by passing an array of strings containing the names of the parameters to the <xref:System.Reflection.Emit.MethodBuilder.DefineGenericParameters%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="29996-131">Esto hace que el método sea un método genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-131">This makes the method a generic method.</span></span> <span data-ttu-id="29996-132">El código siguiente hace que `Factory` sea un método genérico con parámetros de tipo `TInput` y `TOutput`.</span><span class="sxs-lookup"><span data-stu-id="29996-132">The following code makes `Factory` a generic method with type parameters `TInput` and `TOutput`.</span></span> <span data-ttu-id="29996-133">Para facilitar la lectura del código, se crean variables con estos nombres para contener los objetos <xref:System.Reflection.Emit.GenericTypeParameterBuilder> que representan los dos parámetros de tipo.</span><span class="sxs-lookup"><span data-stu-id="29996-133">To make the code easier to read, variables with these names are created to hold the <xref:System.Reflection.Emit.GenericTypeParameterBuilder> objects representing the two type parameters.</span></span>

    [!code-csharp[GenericMethodHowTo#5](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#5)]
    [!code-vb[GenericMethodHowTo#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#5)]

6. <span data-ttu-id="29996-134">También tiene la opción de agregar restricciones especiales a los parámetros de tipo.</span><span class="sxs-lookup"><span data-stu-id="29996-134">Optionally add special constraints to the type parameters.</span></span> <span data-ttu-id="29996-135">Las restricciones especiales se agregan utilizando el método <xref:System.Reflection.Emit.GenericTypeParameterBuilder.SetGenericParameterAttributes%2A>.</span><span class="sxs-lookup"><span data-stu-id="29996-135">Special constraints are added using the <xref:System.Reflection.Emit.GenericTypeParameterBuilder.SetGenericParameterAttributes%2A> method.</span></span> <span data-ttu-id="29996-136">En este ejemplo, `TOutput` está restringido a ser un tipo de referencia y tener un constructor sin parámetros.</span><span class="sxs-lookup"><span data-stu-id="29996-136">In this example, `TOutput` is constrained to be a reference type and to have a parameterless constructor.</span></span>

    [!code-csharp[GenericMethodHowTo#6](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#6)]
    [!code-vb[GenericMethodHowTo#6](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#6)]

7. <span data-ttu-id="29996-137">También tiene la opción de agregar restricciones de clase y de interfaz a los parámetros de tipo.</span><span class="sxs-lookup"><span data-stu-id="29996-137">Optionally add class and interface constraints to the type parameters.</span></span> <span data-ttu-id="29996-138">En este ejemplo, el parámetro de tipo `TOutput` está restringido a tipos que implementan la interfaz `ICollection(Of TInput)` (`ICollection<TInput>` en C#).</span><span class="sxs-lookup"><span data-stu-id="29996-138">In this example, type parameter `TOutput` is constrained to types that implement the `ICollection(Of TInput)` (`ICollection<TInput>` in C#) interface.</span></span> <span data-ttu-id="29996-139">Esto garantiza que el método <xref:System.Collections.Generic.ICollection%601.Add%2A> se puede utilizar para agregar elementos.</span><span class="sxs-lookup"><span data-stu-id="29996-139">This ensures that the <xref:System.Collections.Generic.ICollection%601.Add%2A> method can be used to add elements.</span></span>

    [!code-csharp[GenericMethodHowTo#7](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#7)]
    [!code-vb[GenericMethodHowTo#7](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#7)]

8. <span data-ttu-id="29996-140">Defina los parámetros formales del método utilizando el método <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A>.</span><span class="sxs-lookup"><span data-stu-id="29996-140">Define the formal parameters of the method, using the <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A> method.</span></span> <span data-ttu-id="29996-141">En este ejemplo, el método `Factory` tiene un parámetro, una matriz de `TInput`.</span><span class="sxs-lookup"><span data-stu-id="29996-141">In this example, the `Factory` method has one parameter, an array of `TInput`.</span></span> <span data-ttu-id="29996-142">Este tipo se crea llamando al método <xref:System.Type.MakeArrayType%2A> de <xref:System.Reflection.Emit.GenericTypeParameterBuilder> que representa `TInput`.</span><span class="sxs-lookup"><span data-stu-id="29996-142">This type is created by calling the <xref:System.Type.MakeArrayType%2A> method on the <xref:System.Reflection.Emit.GenericTypeParameterBuilder> that represents `TInput`.</span></span> <span data-ttu-id="29996-143">El argumento de <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A> es una matriz de objetos <xref:System.Type>.</span><span class="sxs-lookup"><span data-stu-id="29996-143">The argument of <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A> is an array of <xref:System.Type> objects.</span></span>

    [!code-csharp[GenericMethodHowTo#8](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#8)]
    [!code-vb[GenericMethodHowTo#8](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#8)]

9. <span data-ttu-id="29996-144">Defina el tipo de valor devuelto para el método utilizando el método <xref:System.Reflection.Emit.MethodBuilder.SetReturnType%2A>.</span><span class="sxs-lookup"><span data-stu-id="29996-144">Define the return type for the method, using the <xref:System.Reflection.Emit.MethodBuilder.SetReturnType%2A> method.</span></span> <span data-ttu-id="29996-145">En este ejemplo se devuelve una instancia de `TOutput`.</span><span class="sxs-lookup"><span data-stu-id="29996-145">In this example, an instance of `TOutput` is returned.</span></span>

    [!code-csharp[GenericMethodHowTo#9](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#9)]
    [!code-vb[GenericMethodHowTo#9](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#9)]

10. <span data-ttu-id="29996-146">Emita el cuerpo del método utilizando <xref:System.Reflection.Emit.ILGenerator>.</span><span class="sxs-lookup"><span data-stu-id="29996-146">Emit the method body, using <xref:System.Reflection.Emit.ILGenerator>.</span></span> <span data-ttu-id="29996-147">Para obtener detalles, vea el procedimiento que lo acompaña para emitir el cuerpo del método.</span><span class="sxs-lookup"><span data-stu-id="29996-147">For details, see the accompanying procedure for emitting the method body.</span></span>

    > [!IMPORTANT]
    > <span data-ttu-id="29996-148">Cuando emita llamadas a métodos de tipo genérico y los argumentos de dichos tipos son parámetros de tipo del método genérico, debe utilizar las sobrecargas de los métodos `static`<xref:System.Reflection.Emit.TypeBuilder.GetConstructor%28System.Type%2CSystem.Reflection.ConstructorInfo%29>, <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29>, y <xref:System.Reflection.Emit.TypeBuilder.GetField%28System.Type%2CSystem.Reflection.FieldInfo%29> de la clase <xref:System.Reflection.Emit.TypeBuilder> para obtener formas construidas de los métodos.</span><span class="sxs-lookup"><span data-stu-id="29996-148">When you emit calls to methods of generic types, and the type arguments of those types are type parameters of the generic method, you must use the `static`<xref:System.Reflection.Emit.TypeBuilder.GetConstructor%28System.Type%2CSystem.Reflection.ConstructorInfo%29>, <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29>, and <xref:System.Reflection.Emit.TypeBuilder.GetField%28System.Type%2CSystem.Reflection.FieldInfo%29> method overloads of the <xref:System.Reflection.Emit.TypeBuilder> class to obtain constructed forms of the methods.</span></span> <span data-ttu-id="29996-149">El procedimiento de acompañamiento para emitir el cuerpo del método muestra esta operación.</span><span class="sxs-lookup"><span data-stu-id="29996-149">The accompanying procedure for emitting the method body demonstrates this.</span></span>

11. <span data-ttu-id="29996-150">Finalice el tipo que contiene el método y guarde el ensamblado.</span><span class="sxs-lookup"><span data-stu-id="29996-150">Complete the type that contains the method and save the assembly.</span></span> <span data-ttu-id="29996-151">El procedimiento de acompañamiento para invocar el método genérico muestra dos maneras de invocar el método completado.</span><span class="sxs-lookup"><span data-stu-id="29996-151">The accompanying procedure for invoking the generic method shows two ways to invoke the completed method.</span></span>

    [!code-csharp[GenericMethodHowTo#14](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#14)]
    [!code-vb[GenericMethodHowTo#14](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#14)]

<a name="procedureSection1"></a>

### <a name="to-emit-the-method-body"></a><span data-ttu-id="29996-152">Para emitir el cuerpo del método</span><span class="sxs-lookup"><span data-stu-id="29996-152">To emit the method body</span></span>

1. <span data-ttu-id="29996-153">Obtenga un generador de código y declare variables y etiquetas locales.</span><span class="sxs-lookup"><span data-stu-id="29996-153">Get a code generator and declare local variables and labels.</span></span> <span data-ttu-id="29996-154">El método <xref:System.Reflection.Emit.ILGenerator.DeclareLocal%2A> se utiliza para declarar las variables locales.</span><span class="sxs-lookup"><span data-stu-id="29996-154">The <xref:System.Reflection.Emit.ILGenerator.DeclareLocal%2A> method is used to declare local variables.</span></span> <span data-ttu-id="29996-155">El método `Factory` tiene cuatro variables locales: `retVal`, que va a albergar el nuevo objeto `TOutput` devuelto por el método; `ic`, que va a contener el parámetro `TOutput` cuando se convierta en `ICollection(Of TInput)` (`ICollection<TInput>` en C#); `input`, que va a contener la matriz de entrada de objetos `TInput`; e `index`, que va a recorrer la matriz en iteración.</span><span class="sxs-lookup"><span data-stu-id="29996-155">The `Factory` method has four local variables: `retVal` to hold the new `TOutput` that is returned by the method, `ic` to hold the `TOutput` when it is cast to `ICollection(Of TInput)` (`ICollection<TInput>` in C#), `input` to hold the input array of `TInput` objects, and `index` to iterate through the array.</span></span> <span data-ttu-id="29996-156">El método también tiene dos etiquetas, una para entrar en el bucle (`enterLoop`) y otra para ir al principio del bucle (`loopAgain`), definidas utilizando el método <xref:System.Reflection.Emit.ILGenerator.DefineLabel%2A>.</span><span class="sxs-lookup"><span data-stu-id="29996-156">The method also has two labels, one to enter the loop (`enterLoop`) and one for the top of the loop (`loopAgain`), defined using the <xref:System.Reflection.Emit.ILGenerator.DefineLabel%2A> method.</span></span>

    <span data-ttu-id="29996-157">Lo primero que hace el método es cargar su argumento utilizando el código de operación <xref:System.Reflection.Emit.OpCodes.Ldarg_0> y almacenándolo en la variable local `input` mediante el código de operación <xref:System.Reflection.Emit.OpCodes.Stloc_S>.</span><span class="sxs-lookup"><span data-stu-id="29996-157">The first thing the method does is to load its argument using <xref:System.Reflection.Emit.OpCodes.Ldarg_0> opcode and to store it in the local variable `input` using <xref:System.Reflection.Emit.OpCodes.Stloc_S> opcode.</span></span>

    [!code-csharp[GenericMethodHowTo#10](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#10)]
    [!code-vb[GenericMethodHowTo#10](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#10)]

2. <span data-ttu-id="29996-158">Emita el código para crear una instancia de `TOutput`, utilizando la sobrecarga de método genérico del método <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="29996-158">Emit code to create an instance of `TOutput`, using the generic method overload of the <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="29996-159">Utilizar esta sobrecarga requiere que el tipo especificado tenga un constructor sin parámetros, que es la razón para agregar esa restricción a `TOutput`.</span><span class="sxs-lookup"><span data-stu-id="29996-159">Using this overload requires the specified type to have a parameterless constructor, which is the reason for adding that constraint to `TOutput`.</span></span> <span data-ttu-id="29996-160">Cree el método genérico construido pasando `TOutput` a <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A>.</span><span class="sxs-lookup"><span data-stu-id="29996-160">Create the constructed generic method by passing `TOutput` to <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A>.</span></span> <span data-ttu-id="29996-161">Después de emitir el código para llamar al método, emita el código para almacenarlo en la variable local `retVal` utilizando <xref:System.Reflection.Emit.OpCodes.Stloc_S>.</span><span class="sxs-lookup"><span data-stu-id="29996-161">After emitting code to call the method, emit code to store it in the local variable `retVal` using <xref:System.Reflection.Emit.OpCodes.Stloc_S></span></span>

    [!code-csharp[GenericMethodHowTo#11](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#11)]
    [!code-vb[GenericMethodHowTo#11](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#11)]

3. <span data-ttu-id="29996-162">Emita el código para convertir el nuevo objeto `TOutput` a `ICollection(Of TInput)` y almacenarlo en la variable local `ic`.</span><span class="sxs-lookup"><span data-stu-id="29996-162">Emit code to cast the new `TOutput` object to `ICollection(Of TInput)` and store it in the local variable `ic`.</span></span>

    [!code-csharp[GenericMethodHowTo#31](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#31)]
    [!code-vb[GenericMethodHowTo#31](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#31)]

4. <span data-ttu-id="29996-163">Obtenga la información <xref:System.Reflection.MethodInfo> que representa el método <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="29996-163">Get a <xref:System.Reflection.MethodInfo> representing the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="29996-164">El método actúa en una interfaz `ICollection(Of TInput)` (`ICollection<TInput>` en C#), por lo que es necesario obtener el método `Add` específico de ese tipo construido.</span><span class="sxs-lookup"><span data-stu-id="29996-164">The method is acting on an `ICollection(Of TInput)` (`ICollection<TInput>` in C#), so it is necessary to get the `Add` method specific to that constructed type.</span></span> <span data-ttu-id="29996-165">El método <xref:System.Type.GetMethod%2A> no se puede obtener para obtener esta <xref:System.Reflection.MethodInfo> directamente desde `icollOfTInput` porque no se admite <xref:System.Type.GetMethod%2A> en tipos que se hayan construido con un <xref:System.Reflection.Emit.GenericTypeParameterBuilder>.</span><span class="sxs-lookup"><span data-stu-id="29996-165">You cannot use the <xref:System.Type.GetMethod%2A> method to get this <xref:System.Reflection.MethodInfo> directly from `icollOfTInput`, because <xref:System.Type.GetMethod%2A> is not supported on a type that has been constructed with a <xref:System.Reflection.Emit.GenericTypeParameterBuilder>.</span></span> <span data-ttu-id="29996-166">En su lugar, llame a <xref:System.Type.GetMethod%2A> de `icoll`, que contiene la definición de tipo genérico para la interfaz genérica <xref:System.Collections.Generic.ICollection%601>.</span><span class="sxs-lookup"><span data-stu-id="29996-166">Instead, call <xref:System.Type.GetMethod%2A> on `icoll`, which contains the generic type definition for the <xref:System.Collections.Generic.ICollection%601> generic interface.</span></span> <span data-ttu-id="29996-167">A continuación, utilice el método <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29>`static` para generar <xref:System.Reflection.MethodInfo> para el tipo construido.</span><span class="sxs-lookup"><span data-stu-id="29996-167">Then use the <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29>`static` method to produce the <xref:System.Reflection.MethodInfo> for the constructed type.</span></span> <span data-ttu-id="29996-168">El código siguiente muestra cómo hacerlo.</span><span class="sxs-lookup"><span data-stu-id="29996-168">The following code demonstrates this.</span></span>

    [!code-csharp[GenericMethodHowTo#12](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#12)]
    [!code-vb[GenericMethodHowTo#12](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#12)]

5. <span data-ttu-id="29996-169">Emita el código para inicializar la variable `index`, cargando un entero 0 de 32 bits y almacenándolo en la variable.</span><span class="sxs-lookup"><span data-stu-id="29996-169">Emit code to initialize the `index` variable, by loading a 32-bit integer 0 and storing it in the variable.</span></span> <span data-ttu-id="29996-170">Emita el código para bifurcar a la etiqueta `enterLoop`.</span><span class="sxs-lookup"><span data-stu-id="29996-170">Emit code to branch to the label `enterLoop`.</span></span> <span data-ttu-id="29996-171">Esta etiqueta no está marcada todavía, porque se encuentra dentro del bucle.</span><span class="sxs-lookup"><span data-stu-id="29996-171">This label has not yet been marked, because it is inside the loop.</span></span> <span data-ttu-id="29996-172">El código del bucle se emite en el siguiente paso.</span><span class="sxs-lookup"><span data-stu-id="29996-172">Code for the loop is emitted in the next step.</span></span>

    [!code-csharp[GenericMethodHowTo#32](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#32)]
    [!code-vb[GenericMethodHowTo#32](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#32)]

6. <span data-ttu-id="29996-173">Emita el código para el bucle.</span><span class="sxs-lookup"><span data-stu-id="29996-173">Emit code for the loop.</span></span> <span data-ttu-id="29996-174">El primer paso es marcar el principio del bucle, llamando a <xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> con la etiqueta `loopAgain`.</span><span class="sxs-lookup"><span data-stu-id="29996-174">The first step is to mark the top of the loop, by calling <xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> with the `loopAgain` label.</span></span> <span data-ttu-id="29996-175">Las instrucciones de bifurcación que utilicen la etiqueta señalarán ahora a este punto del código.</span><span class="sxs-lookup"><span data-stu-id="29996-175">Branch statements that use the label will now branch to this point in the code.</span></span> <span data-ttu-id="29996-176">El paso siguiente es colocar en la pila el objeto `TOutput`, convertido a `ICollection(Of TInput)`.</span><span class="sxs-lookup"><span data-stu-id="29996-176">The next step is to push the `TOutput` object, cast to `ICollection(Of TInput)`, onto the stack.</span></span> <span data-ttu-id="29996-177">No se necesita inmediatamente, pero debe estar en posición para llamar al método `Add`.</span><span class="sxs-lookup"><span data-stu-id="29996-177">It is not needed immediately, but needs to be in position for calling the `Add` method.</span></span> <span data-ttu-id="29996-178">A continuación, se inserta la matriz de entrada en la pila y, después, en la matriz se inserta la variable `index` que contiene el índice actual.</span><span class="sxs-lookup"><span data-stu-id="29996-178">Next the input array is pushed onto the stack, then the `index` variable containing the current index into the array.</span></span> <span data-ttu-id="29996-179">El código de operación <xref:System.Reflection.Emit.OpCodes.Ldelem> extrae de la pila el índice y la matriz e inserta en la pila el elemento de matriz indizado.</span><span class="sxs-lookup"><span data-stu-id="29996-179">The <xref:System.Reflection.Emit.OpCodes.Ldelem> opcode pops the index and the array off the stack and pushes the indexed array element onto the stack.</span></span> <span data-ttu-id="29996-180">Ahora la pila está lista para la llamada al método <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType>, que extrae de la pila la colección y el nuevo elemento, y agrega el elemento a la colección.</span><span class="sxs-lookup"><span data-stu-id="29996-180">The stack is now ready for the call to the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method, which pops the collection and the new element off the stack and adds the element to the collection.</span></span>

    <span data-ttu-id="29996-181">En el resto del código del bucle se incrementa el índice y se comprueba si el bucle ha finalizado: el índice y un entero de 32 bits se insertan en la pila y se suman, dejando la suma en la pila; la suma se almacena en `index`.</span><span class="sxs-lookup"><span data-stu-id="29996-181">The rest of the code in the loop increments the index and tests to see whether the loop is finished: The index and a 32-bit integer 1 are pushed onto the stack and added, leaving the sum on the stack; the sum is stored in `index`.</span></span> <span data-ttu-id="29996-182">Se invoca <xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> para establecer este punto como punto de entrada del bucle.</span><span class="sxs-lookup"><span data-stu-id="29996-182"><xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> is called to set this point as the entry point for the loop.</span></span> <span data-ttu-id="29996-183">Se vuelve a cargar el índice.</span><span class="sxs-lookup"><span data-stu-id="29996-183">The index is loaded again.</span></span> <span data-ttu-id="29996-184">La matriz de entrada se inserta en la pila y se emite <xref:System.Reflection.Emit.OpCodes.Ldlen> para obtener su longitud.</span><span class="sxs-lookup"><span data-stu-id="29996-184">The input array is pushed on the stack, and <xref:System.Reflection.Emit.OpCodes.Ldlen> is emitted to get its length.</span></span> <span data-ttu-id="29996-185">Ahora en la pila están el índice y la longitud, y se emite <xref:System.Reflection.Emit.OpCodes.Clt> para compararlos.</span><span class="sxs-lookup"><span data-stu-id="29996-185">The index and the length are now on the stack, and <xref:System.Reflection.Emit.OpCodes.Clt> is emitted to compare them.</span></span> <span data-ttu-id="29996-186">Si el índice es menor que la longitud, <xref:System.Reflection.Emit.OpCodes.Brtrue_S> se vuelve a bifurcar hasta el principio del bucle.</span><span class="sxs-lookup"><span data-stu-id="29996-186">If the index is less than the length, <xref:System.Reflection.Emit.OpCodes.Brtrue_S> branches back to the beginning of the loop.</span></span>

    [!code-csharp[GenericMethodHowTo#13](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#13)]
    [!code-vb[GenericMethodHowTo#13](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#13)]

7. <span data-ttu-id="29996-187">Emita el código para insertar el objeto `TOutput` en la pila y volver del método.</span><span class="sxs-lookup"><span data-stu-id="29996-187">Emit code to push the `TOutput` object onto the stack and return from the method.</span></span> <span data-ttu-id="29996-188">Ambas variables locales, `retVal` e `ic`, contienen referencias al nuevo `TOutput`; `ic` sólo se utiliza para tener acceso al método <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="29996-188">The local variables `retVal` and `ic` both contain references to the new `TOutput`; `ic` is used only to access the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method.</span></span>

    [!code-csharp[GenericMethodHowTo#33](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#33)]
    [!code-vb[GenericMethodHowTo#33](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#33)]

<a name="procedureSection2"></a>

### <a name="to-invoke-the-generic-method"></a><span data-ttu-id="29996-189">Para invocar el método genérico</span><span class="sxs-lookup"><span data-stu-id="29996-189">To invoke the generic method</span></span>

1. <span data-ttu-id="29996-190">`Factory` es una definición de método genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-190">`Factory` is a generic method definition.</span></span> <span data-ttu-id="29996-191">Para invocarlo, debe asignar los tipos a sus parámetros de tipo genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-191">In order to invoke it, you must assign types to its generic type parameters.</span></span> <span data-ttu-id="29996-192">Para ello, utilice el método <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A>.</span><span class="sxs-lookup"><span data-stu-id="29996-192">Use the <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A> method to do this.</span></span> <span data-ttu-id="29996-193">El código siguiente crea un método genérico construido, especifica <xref:System.String> para `TInput` y `List(Of String)` (`List<string>` en C#) para `TOutput`, y muestra una representación de cadena del método.</span><span class="sxs-lookup"><span data-stu-id="29996-193">The following code creates a constructed generic method, specifying <xref:System.String> for `TInput` and `List(Of String)` (`List<string>` in C#) for `TOutput`, and displays a string representation of the method.</span></span>

    [!code-csharp[GenericMethodHowTo#21](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#21)]
    [!code-vb[GenericMethodHowTo#21](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#21)]

2. <span data-ttu-id="29996-194">Para invocar el método enlazado en tiempo de ejecución, utilice el método <xref:System.Reflection.MethodBase.Invoke%2A>.</span><span class="sxs-lookup"><span data-stu-id="29996-194">To invoke the method late-bound, use the <xref:System.Reflection.MethodBase.Invoke%2A> method.</span></span> <span data-ttu-id="29996-195">El código siguiente crea una matriz de <xref:System.Object>, que contiene como único elemento una matriz de cadenas, y lo pasa como la lista de argumentos para el método genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-195">The following code creates an array of <xref:System.Object>, containing as its only element an array of strings, and passes it as the argument list for the generic method.</span></span> <span data-ttu-id="29996-196">El primer parámetro de <xref:System.Reflection.MethodBase.Invoke%2A> es una referencia nula porque el método es `static`.</span><span class="sxs-lookup"><span data-stu-id="29996-196">The first parameter of <xref:System.Reflection.MethodBase.Invoke%2A> is a null reference because the method is `static`.</span></span> <span data-ttu-id="29996-197">El valor devuelto se convierte a `List(Of String)` y se muestra su primer elemento.</span><span class="sxs-lookup"><span data-stu-id="29996-197">The return value is cast to `List(Of String)`, and its first element is displayed.</span></span>

    [!code-csharp[GenericMethodHowTo#22](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#22)]
    [!code-vb[GenericMethodHowTo#22](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#22)]

3. <span data-ttu-id="29996-198">Para invocar el método mediante un delegado, debe tener un delegado que coincida con la firma del método genérico construido.</span><span class="sxs-lookup"><span data-stu-id="29996-198">To invoke the method using a delegate, you must have a delegate that matches the signature of the constructed generic method.</span></span> <span data-ttu-id="29996-199">Una manera fácil de hacerlo es crear un delegado genérico.</span><span class="sxs-lookup"><span data-stu-id="29996-199">An easy way to do this is to create a generic delegate.</span></span> <span data-ttu-id="29996-200">El código siguiente crea una instancia del delegado genérico `D` definido en el código de ejemplo utilizando la sobrecarga del método <xref:System.Delegate.CreateDelegate%28System.Type%2CSystem.Reflection.MethodInfo%29?displayProperty=nameWithType> e invoca el delegado.</span><span class="sxs-lookup"><span data-stu-id="29996-200">The following code creates an instance of the generic delegate `D` defined in the example code, using the <xref:System.Delegate.CreateDelegate%28System.Type%2CSystem.Reflection.MethodInfo%29?displayProperty=nameWithType> method overload, and invokes the delegate.</span></span> <span data-ttu-id="29996-201">El rendimiento de los delegados es mejor que el de las llamadas enlazadas en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="29996-201">Delegates perform better than late-bound calls.</span></span>

    [!code-csharp[GenericMethodHowTo#23](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#23)]
    [!code-vb[GenericMethodHowTo#23](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#23)]

4. <span data-ttu-id="29996-202">También se puede llamar al método emitido desde un programa que haga referencia al ensamblado guardado.</span><span class="sxs-lookup"><span data-stu-id="29996-202">The emitted method can also be called from a program that refers to the saved assembly.</span></span>

## <a name="example"></a><span data-ttu-id="29996-203">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="29996-203">Example</span></span>

<span data-ttu-id="29996-204">El ejemplo de código siguiente crea un tipo no genérico, `DemoType`, con un método genérico, `Factory`.</span><span class="sxs-lookup"><span data-stu-id="29996-204">The following code example creates a nongeneric type, `DemoType`, with a generic method, `Factory`.</span></span> <span data-ttu-id="29996-205">Este método tiene dos parámetros de tipo genérico: `TInput` para especificar un tipo de entrada y `TOutput` para especificar un tipo de salida.</span><span class="sxs-lookup"><span data-stu-id="29996-205">This method has two generic type parameters, `TInput` to specify an input type and `TOutput` to specify an output type.</span></span> <span data-ttu-id="29996-206">El parámetro de tipo `TOutput` está restringido a implementar `ICollection<TInput>` (`ICollection(Of TInput)` en Visual Basic), ser un tipo de referencia y tener un constructor sin parámetros.</span><span class="sxs-lookup"><span data-stu-id="29996-206">The `TOutput` type parameter is constrained to implement `ICollection<TInput>` (`ICollection(Of TInput)` in Visual Basic), to be a reference type, and to have a parameterless constructor.</span></span>

<span data-ttu-id="29996-207">El método tiene un parámetro formal que es una matriz de `TInput`.</span><span class="sxs-lookup"><span data-stu-id="29996-207">The method has one formal parameter, which is an array of `TInput`.</span></span> <span data-ttu-id="29996-208">El método devuelve una instancia de `TOutput` que contiene todos los elementos de la matriz de entrada.</span><span class="sxs-lookup"><span data-stu-id="29996-208">The method returns an instance of `TOutput` that contains all the elements of the input array.</span></span> <span data-ttu-id="29996-209">`TOutput` puede ser cualquier tipo de colección genérico que implemente la interfaz genérica <xref:System.Collections.Generic.ICollection%601>.</span><span class="sxs-lookup"><span data-stu-id="29996-209">`TOutput` can be any generic collection type that implements the <xref:System.Collections.Generic.ICollection%601> generic interface.</span></span>

<span data-ttu-id="29996-210">Cuando se ejecuta el código, el ensamblado dinámico se guarda como DemoGenericMethod1.dll y se puede examinar con [Ildasm.exe (Desensamblador de IL)](../tools/ildasm-exe-il-disassembler.md).</span><span class="sxs-lookup"><span data-stu-id="29996-210">When the code is executed, the dynamic assembly is saved as DemoGenericMethod1.dll, and can be examined using the [Ildasm.exe (IL Disassembler)](../tools/ildasm-exe-il-disassembler.md).</span></span>

> [!NOTE]
> <span data-ttu-id="29996-211">Una buena manera de aprender cómo emitir código es escribir un programa de Visual Basic, C# o Visual C++ que realice la tarea que está intentando emitir y utilizar el desensamblador para examinar el código MSIL producido por el compilador.</span><span class="sxs-lookup"><span data-stu-id="29996-211">A good way to learn how to emit code is to write a Visual Basic, C#, or Visual C++ program that performs the task you are trying to emit, and use the disassembler to examine the MSIL produced by the compiler.</span></span>

<span data-ttu-id="29996-212">El ejemplo de código incluye código fuente que es equivalente al método emitido.</span><span class="sxs-lookup"><span data-stu-id="29996-212">The code example includes source code that is equivalent to the emitted method.</span></span> <span data-ttu-id="29996-213">El método emitido se invoca enlazado en tiempo de ejecución y también utilizando un delegado genérico declarado en el ejemplo de código.</span><span class="sxs-lookup"><span data-stu-id="29996-213">The emitted method is invoked late-bound and also by using a generic delegate declared in the code example.</span></span>

[!code-csharp[GenericMethodHowTo#1](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#1)]
[!code-vb[GenericMethodHowTo#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#1)]

## <a name="see-also"></a><span data-ttu-id="29996-214">Vea también</span><span class="sxs-lookup"><span data-stu-id="29996-214">See also</span></span>

- <xref:System.Reflection.Emit.MethodBuilder>
- [<span data-ttu-id="29996-215">Cómo: Definir un tipo genérico con emisión de reflexión</span><span class="sxs-lookup"><span data-stu-id="29996-215">How to: Define a Generic Type with Reflection Emit</span></span>](how-to-define-a-generic-type-with-reflection-emit.md)
