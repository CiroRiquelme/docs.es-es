---
title: Patrones de resistencia de las aplicaciones
description: Diseño de aplicaciones .NET nativas en la nube para Azure | Patrones de resistencia de aplicaciones
ms.date: 06/30/2019
ms.openlocfilehash: 6805603f349578655b2535c7346af368c5ce1841
ms.sourcegitcommit: 5988e9a29cedb8757320817deda3c08c6f44a6aa
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/28/2020
ms.locfileid: "82199695"
---
# <a name="application-resiliency-patterns"></a><span data-ttu-id="e8cb6-103">Patrones de resistencia de las aplicaciones</span><span class="sxs-lookup"><span data-stu-id="e8cb6-103">Application resiliency patterns</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="e8cb6-104">La primera línea de defensa es la resistencia de las aplicaciones habilitadas para software.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-104">The first line of defense is software-enabled application resiliency.</span></span>

<span data-ttu-id="e8cb6-105">Aunque podría invertir un tiempo considerable en escribir su propio marco de resistencia, tales productos ya existen.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-105">While you could invest considerable time writing your own resiliency framework, such products already exist.</span></span> <span data-ttu-id="e8cb6-106">Por ejemplo, [Polly](http://www.thepollyproject.org/) es una biblioteca completa de resistencia de .net y control de errores transitorios que permite a los desarrolladores expresar directivas de resistencia de forma fluida y segura para subprocesos.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-106">For example, [Polly](http://www.thepollyproject.org/) is a comprehensive .NET resilience and transient-fault-handling library that allows developers to express resiliency policies in a fluent and thread-safe manner.</span></span> <span data-ttu-id="e8cb6-107">Polly tiene como destino aplicaciones compiladas con la .NET Framework completa o .NET Core.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-107">Polly targets applications built with either the full .NET Framework or .NET Core.</span></span> <span data-ttu-id="e8cb6-108">En la figura 6-2 se muestran las directivas de resistencia (es decir, la funcionalidad) disponibles en la biblioteca Polly.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-108">Figure 6-2 shows the resiliency policies (that is, functionality) available from the Polly Library.</span></span> <span data-ttu-id="e8cb6-109">Estas directivas se pueden aplicar de forma individual o combinada.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-109">These policies can be applied individually or combined together.</span></span>

![Marco de Polly](./media/polly-resiliency-framework.png)

<span data-ttu-id="e8cb6-111">**Figura 6-2**.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-111">**Figure 6-2**.</span></span> <span data-ttu-id="e8cb6-112">Características del marco de resistencia de Polly</span><span class="sxs-lookup"><span data-stu-id="e8cb6-112">Polly resiliency framework features</span></span>

<span data-ttu-id="e8cb6-113">Observe cómo en la figura anterior las directivas de resistencia se aplican a los mensajes de solicitud, tanto si proceden de un cliente externo como de otro servicio back-end.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-113">Note how in the previous figure the resiliency policies apply to request messages, whether coming from an external client or another back-end service.</span></span> <span data-ttu-id="e8cb6-114">El objetivo es compensar la solicitud de un servicio que puede estar temporalmente no disponible.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-114">The goal is to compensate the request for a service that might be momentarily unavailable.</span></span> <span data-ttu-id="e8cb6-115">Estas breves interrupciones suelen manifestarse con los códigos de Estado HTTP que se muestran en la figura 6-3.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-115">These short interruptions typically manifest themselves with the HTTP status codes shown in Figure 6-3.</span></span>

![Códigos de Estado HTTP para reintentar](./media/http-status-codes.png)

<span data-ttu-id="e8cb6-117">**Figura 6-3**.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-117">**Figure 6-3**.</span></span> <span data-ttu-id="e8cb6-118">Códigos de Estado HTTP para reintentar</span><span class="sxs-lookup"><span data-stu-id="e8cb6-118">HTTP status codes to retry</span></span>

<span data-ttu-id="e8cb6-119">Pregunta: ¿reintentaría un código de Estado HTTP de 403-prohibido?</span><span class="sxs-lookup"><span data-stu-id="e8cb6-119">Question: Would you retry an HTTP Status Code of 403 - Forbidden?</span></span> <span data-ttu-id="e8cb6-120">No.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-120">No.</span></span> <span data-ttu-id="e8cb6-121">En este caso, el sistema funciona correctamente, pero informa al llamador de que no está autorizado para realizar la operación solicitada.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-121">Here, the system is functioning properly, but informing the caller that they aren't authorized to perform the requested operation.</span></span> <span data-ttu-id="e8cb6-122">Se debe tener cuidado para reintentar solo las operaciones causadas por errores.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-122">Care must be taken to retry only those operations caused by failures.</span></span>

<span data-ttu-id="e8cb6-123">Como se recomienda en el capítulo 1, los desarrolladores de Microsoft que crean aplicaciones nativas de la nube deben tener como destino .NET Core.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-123">As recommended in Chapter 1, Microsoft developers constructing cloud-native applications should target .NET Core.</span></span> <span data-ttu-id="e8cb6-124">La versión 2,1 presentó la biblioteca [HTTPClientFactory](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore) para crear instancias de cliente http para interactuar con recursos basados en URL.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-124">Version 2.1 introduced the [HTTPClientFactory](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore) library for creating HTTP Client instances for interacting with URL-based resources.</span></span> <span data-ttu-id="e8cb6-125">Al sustituir la clase HTTPClient original, la clase Factory admite muchas características mejoradas, una de las cuales es una [integración estrecha](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md) con la biblioteca de resistencia Polly.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-125">Superseding the original HTTPClient class, the factory class supports many enhanced features, one of which is [tight integration](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md) with the Polly resiliency library.</span></span> <span data-ttu-id="e8cb6-126">Con él, puede definir fácilmente directivas de resistencia en la clase de inicio de la aplicación para controlar los errores parciales y los problemas de conectividad.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-126">With it, you can easily define resiliency policies in the application Startup class to handle partial failures and connectivity issues.</span></span>

<span data-ttu-id="e8cb6-127">A continuación, vamos a expandir los patrones de reintento y de disyuntor.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-127">Next, let's expand on retry and circuit breaker patterns.</span></span>

### <a name="retry-pattern"></a><span data-ttu-id="e8cb6-128">Patrón Retry</span><span class="sxs-lookup"><span data-stu-id="e8cb6-128">Retry pattern</span></span>

<span data-ttu-id="e8cb6-129">En un entorno de nube nativo distribuido, las llamadas a los servicios y a los recursos en la nube pueden producir errores debido a errores transitorios (de corta duración), que normalmente se corrigen después de un breve período de tiempo.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-129">In a distributed cloud-native environment, calls to services and cloud resources can fail because of transient (short-lived) failures, which typically correct themselves after a brief period of time.</span></span> <span data-ttu-id="e8cb6-130">La implementación de una estrategia de reintento ayuda a un servicio nativo de la nube a administrar estos escenarios.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-130">Implementing a retry strategy helps a cloud-native service handle these scenarios.</span></span>

<span data-ttu-id="e8cb6-131">El [patrón Retry](https://docs.microsoft.com/azure/architecture/patterns/retry) permite a un servicio volver a intentar una operación de solicitud con error un número (configurable) de veces con un tiempo de espera que aumenta exponencialmente.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-131">The [Retry pattern](https://docs.microsoft.com/azure/architecture/patterns/retry) enables a service to retry a failed request operation a (configurable) number of times with an exponentially increasing wait time.</span></span> <span data-ttu-id="e8cb6-132">En la figura 6-4 se muestra una acción de reintento.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-132">Figure 6-4 shows a retry in action.</span></span>

![Patrón de reintento en acción](./media/retry-pattern.png)

<span data-ttu-id="e8cb6-134">**Figura 6-4**.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-134">**Figure 6-4**.</span></span> <span data-ttu-id="e8cb6-135">Patrón de reintento en acción</span><span class="sxs-lookup"><span data-stu-id="e8cb6-135">Retry pattern in action</span></span>

<span data-ttu-id="e8cb6-136">En la ilustración anterior, se ha implementado un patrón de reintento para una operación de solicitud.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-136">In the previous figure, a retry pattern has been implemented for a request operation.</span></span> <span data-ttu-id="e8cb6-137">Está configurado para permitir hasta cuatro reintentos antes de que se produzca un error en un intervalo de retroceso (tiempo de espera) a partir de dos segundos, lo que se duplica exponencialmente para cada intento posterior.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-137">It's configured to allow up to four retries before failing with a backoff interval (wait time) starting at two seconds, which exponentially doubles for each subsequent attempt.</span></span>

- <span data-ttu-id="e8cb6-138">Se produce un error en la primera invocación y se devuelve un código de Estado HTTP de 500.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-138">The first invocation fails and returns an HTTP status code of 500.</span></span> <span data-ttu-id="e8cb6-139">La aplicación espera dos segundos y vuelve a intentar la llamada.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-139">The application waits for two seconds and retries the call.</span></span>
- <span data-ttu-id="e8cb6-140">También se produce un error en la segunda invocación y se devuelve un código de Estado HTTP de 500.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-140">The second invocation also fails and returns an HTTP status code of 500.</span></span> <span data-ttu-id="e8cb6-141">La aplicación ahora duplica el intervalo de retroceso en cuatro segundos y vuelve a intentar la llamada.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-141">The application now doubles the backoff interval to four seconds and retries the call.</span></span>
- <span data-ttu-id="e8cb6-142">Por último, la tercera llamada se realiza correctamente.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-142">Finally, the third call succeeds.</span></span>
- <span data-ttu-id="e8cb6-143">En este escenario, la operación de reintento habría intentado hasta cuatro reintentos mientras doblaba la duración de la interrupción antes de que se produjera un error en la llamada.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-143">In this scenario, the retry operation would have attempted up to four retries while doubling the backoff duration before failing the call.</span></span>

<span data-ttu-id="e8cb6-144">Es importante aumentar el período de interrupción antes de reintentar la llamada para permitir que el tiempo de servicio se corrija automáticamente.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-144">It's important to increase the backoff period before retrying the call to allow the service time to self-correct.</span></span> <span data-ttu-id="e8cb6-145">Se recomienda implementar un retroceso que aumenta exponencialmente (duplicando el período en cada reintento) para permitir el tiempo de corrección adecuado.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-145">It's a best practice to implement an exponentially increasing backoff (doubling the period on each retry) to allow adequate correction time.</span></span>

## <a name="circuit-breaker-pattern"></a><span data-ttu-id="e8cb6-146">Patrón de disyuntor</span><span class="sxs-lookup"><span data-stu-id="e8cb6-146">Circuit breaker pattern</span></span>

<span data-ttu-id="e8cb6-147">Aunque el patrón de reintento puede ayudar a salvar una solicitud en un error parcial, existen situaciones en las que los errores pueden deberse a eventos imprevistos que requerirán períodos más largos de tiempo para resolverse.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-147">While the retry pattern can help salvage a request entangled in a partial failure, there are situations where failures can be caused by unanticipated events that will require longer periods of time to resolve.</span></span> <span data-ttu-id="e8cb6-148">La gravedad de estos errores puede ir desde una pérdida parcial de conectividad hasta el fallo total del servicio.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-148">These faults can range in severity from a partial loss of connectivity to the complete failure of a service.</span></span> <span data-ttu-id="e8cb6-149">En estas situaciones, es poco puntual que una aplicación vuelva a intentar continuamente una operación que es improbable que se realice correctamente.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-149">In these situations, it's pointless for an application to continually retry an operation that is unlikely to succeed.</span></span>

<span data-ttu-id="e8cb6-150">Para empeorar todo, la ejecución de operaciones de reintento continuo en un servicio que no responde puede pasar a un escenario de denegación de servicio autoimpuesta en el que se inunda el servicio con llamadas continuas que agotan los recursos como la memoria, los subprocesos y las conexiones de base de datos, lo que provoca errores en partes no relacionadas del sistema que usan los mismos recursos.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-150">To make things worse, executing continual retry operations on a non-responsive service can move you into a self-imposed denial of service scenario where you flood your service with continual calls exhausting resources such as memory, threads and database connections, causing failure in unrelated parts of the system that use the same resources.</span></span>

<span data-ttu-id="e8cb6-151">En estas situaciones, sería preferible que la operación produjera un error inmediatamente y solo intentara invocar el servicio si es probable que se realizara correctamente.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-151">In these situations, it would be preferable for the operation to fail immediately and only attempt to invoke the service if it's likely to succeed.</span></span>

<span data-ttu-id="e8cb6-152">El [patrón](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker) de disyuntor puede impedir que una aplicación intente ejecutar repetidamente una operación que es probable que produzca un error.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-152">The [Circuit Breaker pattern](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker) can prevent an application from repeatedly trying to execute an operation that's likely to fail.</span></span> <span data-ttu-id="e8cb6-153">También supervisa la aplicación con una llamada de prueba periódica para determinar si el error se ha resuelto.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-153">It also monitors the application with a periodic trial call to determine whether the fault has resolved.</span></span> <span data-ttu-id="e8cb6-154">En la figura 6-5 se muestra el patrón de disyuntor en acción.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-154">Figure 6-5 shows the Circuit Breaker pattern in action.</span></span>

![Patrón de disyuntor en acción](./media/circuit-breaker-pattern.png)

<span data-ttu-id="e8cb6-156">**Figura 6-5**.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-156">**Figure 6-5**.</span></span> <span data-ttu-id="e8cb6-157">Patrón de disyuntor en acción</span><span class="sxs-lookup"><span data-stu-id="e8cb6-157">Circuit breaker pattern in action</span></span>

<span data-ttu-id="e8cb6-158">En la ilustración anterior, se ha agregado un patrón de disyuntor al patrón de reintento original.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-158">In the previous figure, a Circuit Breaker pattern has been added to the original retry pattern.</span></span> <span data-ttu-id="e8cb6-159">Observe que, después de 10 solicitudes con error, los disyuntores se abren y ya no permiten llamadas al servicio.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-159">Note how after 10 failed requests, the circuit breakers opens and no longer allows calls to the service.</span></span> <span data-ttu-id="e8cb6-160">El valor CheckCircuit, establecido en 30 segundos, especifica la frecuencia con la que la biblioteca permite que una solicitud continúe en el servicio.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-160">The CheckCircuit value, set at 30 seconds, specifies how often the library allows one request to proceed to the service.</span></span> <span data-ttu-id="e8cb6-161">Si la llamada se realiza correctamente, el circuito se cierra y el servicio vuelve a estar disponible para el tráfico.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-161">If that call succeeds, the circuit closes and the service is once again available to traffic.</span></span>

<span data-ttu-id="e8cb6-162">Tenga en cuenta que la intención del patrón de disyuntor es *diferente* de la del patrón de reintento.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-162">Keep in mind that the intent of the Circuit Breaker pattern is *different* than that of the Retry pattern.</span></span> <span data-ttu-id="e8cb6-163">El patrón de reintento permite que una aplicación vuelva a intentar una operación en la expectativa de que se realizará correctamente.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-163">The Retry pattern enables an application to retry an operation in the expectation that it will succeed.</span></span> <span data-ttu-id="e8cb6-164">El patrón de disyuntor impide que una aplicación realice una operación que es probable que produzca un error.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-164">The Circuit Breaker pattern prevents an application from doing an operation that is likely to fail.</span></span> <span data-ttu-id="e8cb6-165">A menudo, una aplicación *combinará* estos dos patrones mediante el patrón de reintento para invocar una operación a través de un disyuntor.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-165">Often, an application will *combine* these two patterns by using the Retry pattern to invoke an operation through a circuit breaker.</span></span> <span data-ttu-id="e8cb6-166">Sin embargo, la lógica de reintentos debe ser sensible a las excepciones devueltas por el disyuntor y abandonar los reintentos si el disyuntor indica que un error no es transitorio.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-166">However, the retry logic should be sensitive to any exceptions returned by the circuit breaker and abandon retry attempts if the circuit breaker indicates that a fault isn't transient.</span></span>

<span data-ttu-id="e8cb6-167">La resistencia de la aplicación es una para controlar las operaciones solicitadas problemáticas.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-167">Application resiliency is a must for handling problematic requested operations.</span></span> <span data-ttu-id="e8cb6-168">Pero es solo la mitad de la historia.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-168">But, it's only half of the story.</span></span> <span data-ttu-id="e8cb6-169">A continuación, se tratan las características de resistencia disponibles en la nube de Azure.</span><span class="sxs-lookup"><span data-stu-id="e8cb6-169">Next, we cover resiliency features available in the Azure cloud.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="e8cb6-170">[Anterior](resiliency.md)
>[Siguiente](infrastructure-resiliency-azure.md)</span><span class="sxs-lookup"><span data-stu-id="e8cb6-170">[Previous](resiliency.md)
[Next](infrastructure-resiliency-azure.md)</span></span>
